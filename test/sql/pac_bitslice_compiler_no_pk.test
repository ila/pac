# name: test/sql/pac_bitslice_compiler_no_pk.test
# description: Test bitslice compiler queries without primary keys (various SUM/COUNT patterns)
# group: [sql]

require pac

# Create two tables with 25 rows each and 5 groups (grp = i % 5)
statement ok
CREATE TABLE bitslice_a AS
SELECT i AS id, i % 5 AS grp, (i % 10) AS val, (i % 3) AS grp2
FROM range(25) t(i)

statement ok
CREATE TABLE bitslice_b AS
SELECT i AS id, i % 5 AS grp, ((i * 2) % 10) AS val_b, (i % 4) AS other
FROM range(25) t(i)

statement ok
pRAGMA add_pac_privacy_unit('bitslice_a');

statement ok
set pac_seed = 42;

# 1) Ungrouped SUM / COUNT on a single table
query I
SELECT SUM(val) FROM bitslice_a
----
123

query I
SELECT COUNT(val) AS c FROM bitslice_a
----
25

# 2) SUM / COUNT + GROUP BY (single grouping column)
query II
SELECT grp, SUM(val)
FROM bitslice_a
GROUP BY grp
ORDER BY grp
----
0	15
1	21
2	22
3	22
4	43

query II
SELECT grp, COUNT(val)
FROM bitslice_a
GROUP BY grp
ORDER BY grp
----
0	5
1	7
2	5
3	4
4	4

# 2b) Multiple aggregates (SUM, COUNT, and AVG) on no-PK table
query IIII
SELECT grp, SUM(val), COUNT(val), AVG(val)::DECIMAL(6, 2)
FROM bitslice_a
GROUP BY grp
ORDER BY grp
----
0	15	5	3.00
1	21	7	4.20
2	22	5	4.40
3	22	4	4.40
4	43	4	8.60

# 3) SUM / COUNT + GROUP BY + WHERE filter
query II
SELECT grp, SUM(val)
FROM bitslice_a
WHERE grp = 0
GROUP BY grp
----
0	15

query II
SELECT grp, COUNT(val)
FROM bitslice_a
WHERE val > 4
GROUP BY grp
ORDER BY grp
----
0	3
1	3
2	4
3	3
4	1

# 4) SUM / COUNT with 2 GROUP BY columns
query III
SELECT grp, grp2, SUM(val)
FROM bitslice_a
GROUP BY grp, grp2
ORDER BY grp, grp2
LIMIT 3
----
0	0	5
0	1	0
0	2	5

query III
SELECT grp, grp2, COUNT(val)
FROM bitslice_a
GROUP BY grp, grp2
ORDER BY grp, grp2
LIMIT 2
----
0	0	1
0	1	0

# Testing with average
query III
SELECT grp, grp2, AVG(val)::DECIMAL(6, 2)
FROM bitslice_a
GROUP BY grp, grp2
ORDER BY grp, grp2
LIMIT 2
----
0	0	2.50
0	1	0.00

#
# # 5) Same GROUP BY columns in different order and with alias/no-alias
query III
SELECT SUM(val) AS s, grp2, grp
FROM bitslice_a
GROUP BY grp2, grp
ORDER BY grp2, grp
LIMIT 3
----
5	0	0
6	0	1
4	0	2


# 6) SUM with JOIN (no GROUP BY)
query I
SELECT SUM(a.val)
FROM bitslice_a a JOIN bitslice_b b ON a.grp = b.grp
----
615

# 7) COUNT with JOIN + GROUP BY
query II
SELECT a.grp, COUNT(a.id)
FROM bitslice_a a JOIN bitslice_b b ON a.grp = b.grp
GROUP BY a.grp
ORDER BY a.grp
----
0	25
1	35
2	25
3	20
4	20

# ========== LEFT JOIN TEST CASES ==========

# Test LEFT JOIN with no-PK table on left
query III
SELECT a.grp, COUNT(*), SUM(COALESCE(b.val_b, 0))
FROM bitslice_a a
LEFT JOIN bitslice_b b ON a.grp = b.grp
GROUP BY a.grp
ORDER BY a.grp
----
0	25	0
1	35	60
2	25	120
3	20	120
4	20	280

# Test LEFT JOIN with aggregate on right table (no PK)
query III
SELECT a.grp, SUM(a.val), COUNT(b.id)
FROM bitslice_a a
LEFT JOIN bitslice_b b ON a.grp = b.grp AND b.other > 2
GROUP BY a.grp
ORDER BY a.grp
----
0	15	5
1	21	7
2	22	5
3	44	8
4	43	4

# Test LEFT JOIN with NULL handling (no PK)
statement ok
INSERT INTO bitslice_a VALUES (100, 5, 99, 0);

query II
SELECT a.grp, SUM(a.val)
FROM bitslice_a a
LEFT JOIN bitslice_b b ON a.grp = b.grp
GROUP BY a.grp
ORDER BY a.grp
----
0	75
1	105
2	110
3	110
4	215
5	0

statement ok
DELETE FROM bitslice_a WHERE id = 100;

# Test multiple LEFT JOINs with no-PK tables
query II
SELECT a.grp, SUM(a.val)
FROM bitslice_a a
LEFT JOIN bitslice_b b ON a.grp = b.grp
LEFT JOIN bitslice_a c ON a.grp2 = c.grp2
GROUP BY a.grp
ORDER BY a.grp
LIMIT 3
----
0	450
1	705
2	865

# Edge case: table that actually has a column named "rowid"
statement ok
CREATE TABLE bitslice_with_rowid AS
SELECT i AS rowid, i % 5 AS grp, (i % 10) AS val
FROM range(10) t(i)

statement ok
pRAGMA add_pac_privacy_unit('bitslice_with_rowid');

query I
SELECT SUM(val) FROM bitslice_with_rowid
----
57

query I
SELECT COUNT(rowid) FROM bitslice_with_rowid
----
9

# Test RIGHT JOIN with no-PK tables, aggregating with filtering condition
query III
SELECT b.grp, COUNT(*), SUM(COALESCE(a.val, 0))
FROM bitslice_a a
RIGHT JOIN bitslice_b b ON a.grp = b.grp AND a.grp2 = 0
GROUP BY b.grp
ORDER BY b.grp
----
0	5	25
1	10	35
2	0	10
3	5	95
4	5	110

# Cleanup
statement ok
DROP TABLE bitslice_a

statement ok
DROP TABLE bitslice_b

statement ok
DROP TABLE bitslice_with_rowid

