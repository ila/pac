# name: test/sql/pac.test
# description: test pac extension
# group: [sql]

# --- PAC privacy unit management and compatibility tests ---

require pac

statement ok
SET pac_noise = false;

statement ok
SET pac_privacy_file = 'test/sql/test_pac_tables.csv';

# Ensure test file is clean
query I
PRAGMA remove_pac_privacy_unit('t1');
----

# Create a test table
statement ok
CREATE TABLE t1(a INTEGER, b INTEGER);

statement ok
INSERT INTO t1 VALUES (1, 10), (2, 20), (3, 30), (3 , 40);

# Try PAC-compatible query before adding to privacy file (should not be PAC compatible)
# (Assume your optimizer or extension exposes a function or error for non-PAC queries; adjust as needed)
# Here we just check add/remove and query logic

# Add table to privacy file (pass filename as second argument) via PRAGMA
query I
PRAGMA add_pac_privacy_unit('t1');
----

# Add again using PRAGMA (should be idempotent)
query I
PRAGMA add_pac_privacy_unit('t1');
----

# PAC-compatible query: SUM
query I
SELECT SUM(b) FROM t1;
----
100

# PAC-compatible query: COUNT
query I
SELECT COUNT(*) FROM t1;
----
4

# PAC-compatible query: AVG
query I
SELECT AVG(b) FROM t1;
----
25

# PAC-compatible query: GROUP BY
query II
SELECT a, SUM(b) FROM t1 GROUP BY a ORDER BY a;
----
1	10
2	20
3	70

# PAC-compatible query: INNER JOIN
statement ok
CREATE TABLE t2(x INTEGER, y INTEGER);

statement ok
INSERT INTO t2 VALUES (1, 100), (2, 200);

query II
SELECT t1.a, SUM(t2.y) FROM t1 INNER JOIN t2 ON t1.a = t2.x GROUP BY t1.a ORDER BY t1.a;
----
1	100
2	200

# PAC-compatible: not a PAC query (table not in privacy file)
query II
SELECT * FROM t2;
----
1	100
2	200

# Not PAC-compatible: MIN (no aggregate)
statement error
SELECT a FROM t1;
----
Query does not contain any allowed aggregation (sum, count, avg)!

# Not PAC-compatible: MIN (forbidden aggregate)
statement error
SELECT MIN(b) FROM t1;
----
Query does not contain any allowed aggregation (sum, count, avg)!

# Not PAC-compatible: OUTER JOIN
statement error
SELECT SUM(b) FROM t1 LEFT OUTER JOIN t2 ON t1.a = t2.x;
----
PAC rewrite: only INNER JOINs are supported for PAC compilation

# PAC-compatible: multiple joins
statement ok
CREATE TABLE t3(m INTEGER, n INTEGER);

statement ok
INSERT INTO t3 VALUES (1, 1000), (2, 2000);

query II
SELECT t1.a, SUM(t3.n) FROM t1 INNER JOIN t2 ON t1.a = t2.x INNER JOIN t3 ON t2.x = t3.m GROUP BY t1.a ORDER BY t1.a;
----
1	1000
2	2000

# Not PAC-compatible: INNER JOIN with other types of joins
statement error
SELECT SUM(b) FROM t1 INNER JOIN t2 ON t1.a = t2.x LEFT OUTER JOIN t3 ON t2.x = t3.m;
----
PAC rewrite: only INNER JOINs are supported for PAC compilation

# Not PAC-compatible: DISTINCT
statement error
SELECT COUNT(DISTINCT a) FROM t1;
----
PAC rewrite: DISTINCT is not supported for PAC compilation

# Not PAC-compatible: window function
statement error
SELECT a, SUM(b) OVER (PARTITION BY a) FROM t1;
----
PAC rewrite: window functions are not supported for PAC compilation

# Remove table from privacy file via PRAGMA
statement ok
PRAGMA remove_pac_privacy_unit('t1');

# Clean up
statement ok
DROP TABLE t1;

statement ok
DROP TABLE t2;

statement ok
SET pac_noise = true;

# Test: queries that already reference the internal PAC sample table should skip PAC compilation
statement ok
DROP TABLE IF EXISTS t_single;

statement ok
CREATE TABLE t_single(rowid BIGINT, group_key VARCHAR, val DOUBLE);

statement ok
INSERT INTO t_single VALUES (1,'A',10.0),(2,'A',11.0),(3,'B',20.0);

statement ok
CREATE TABLE _pac_internal_sample_t_single(rowid BIGINT, sample_id BIGINT);

statement ok
INSERT INTO _pac_internal_sample_t_single VALUES (1,1),(2,1),(3,1);

statement ok
PRAGMA add_pac_privacy_unit('t_single');

# The query references both the privacy unit table and the internal sample table. The optimizer
# should detect the internal sample and skip PAC compilation, so the real aggregation result
# should be produced (not the DUMMY output from the PAC compiler).

query II
SELECT t.group_key, SUM(t.val) FROM t_single t JOIN _pac_internal_sample_t_single s USING(rowid) GROUP BY t.group_key ORDER BY t.group_key;
----
A	21
B	20

statement ok
PRAGMA remove_pac_privacy_unit('t_single');

statement ok
DROP TABLE IF EXISTS t_single;

# Reset privacy file
statement ok
SET pac_privacy_file = '';
