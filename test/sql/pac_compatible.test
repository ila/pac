# name: test/sql/pac_compatible.test
# description: test pac extension
# group: [sql]

# --- PAC privacy unit management and compatibility tests ---

require pac

statement ok
PRAGMA clear_pac_metadata;

statement ok
SET pac_seed = 42

statement ok
SET pac_deterministic_noise = true

statement ok
SET threads = 1

statement ok
SET pac_mi = 0

statement ok
SET pac_noise = false;

statement ok
SET pac_privacy_file = 'test/sql/test_pac_tables.csv';

# Ensure test file is clean
query I
PRAGMA remove_pac_privacy_unit('t1');
----

# Create a test table
statement ok
CREATE TABLE t1(a INTEGER, b INTEGER);

statement ok
INSERT INTO t1 VALUES (1, 10), (2, 20), (3, 30), (3 , 40);

# Try PAC-compatible query before adding to privacy file (should not be PAC compatible)
# (Assume your optimizer or extension exposes a function or error for non-PAC queries; adjust as needed)
# Here we just check add/remove and query logic

# Add table to privacy file (pass filename as second argument) via PRAGMA
query I
PRAGMA add_pac_privacy_unit('t1');
----

# PAC-compatible query: SUM
query I
SELECT SUM(b) FROM t1;
----
100

# PAC-compatible query: COUNT
query I
SELECT COUNT(*) FROM t1;
----
4

# PAC-compatible query: AVG
query I
SELECT AVG(b) FROM t1;
----
25

# Not PAC-compatible: GROUP BY on PU column (even with aggregate, the GROUP BY itself is not allowed)
statement error
SELECT a, SUM(b) FROM t1 GROUP BY a ORDER BY a;
----
PAC rewrite: columns from privacy unit tables can only be accessed inside aggregate functions (e.g., SUM, COUNT, AVG, MIN, MAX)

# PAC-compatible query: INNER JOIN
statement ok
CREATE TABLE t2(x INTEGER, y INTEGER);

statement ok
INSERT INTO t2 VALUES (1, 100), (2, 200);

# Not PAC-compatible: GROUP BY on PU column in join
statement error
SELECT t1.a, SUM(t2.y) FROM t1 INNER JOIN t2 ON t1.a = t2.x GROUP BY t1.a ORDER BY t1.a;
----
PAC rewrite: columns from privacy unit tables can only be accessed inside aggregate functions (e.g., SUM, COUNT, AVG, MIN, MAX)

# PAC-compatible: not a PAC query (table not in privacy file)
query II
SELECT * FROM t2;
----
1	100
2	200

# Not PAC-compatible: no aggregate
statement error
SELECT a FROM t1;
----
Invalid Input Error: Query does not contain any allowed aggregation (sum, count, avg, min, max)!

# PAC-compatible: MIN
query I
SELECT MIN(a) FROM t1;
----
1

# PAC-compatible: multiple joins with non-PU GROUP BY
statement ok
CREATE TABLE t3(m INTEGER, n INTEGER);

statement ok
INSERT INTO t3 VALUES (1, 1000), (2, 2000);

# Not PAC-compatible: GROUP BY on PU column even in multi-table join
statement error
SELECT t1.a, SUM(t3.n) FROM t1 INNER JOIN t2 ON t1.a = t2.x INNER JOIN t3 ON t2.x = t3.m GROUP BY t1.a ORDER BY t1.a;
----
PAC rewrite: columns from privacy unit tables can only be accessed inside aggregate functions (e.g., SUM, COUNT, AVG, MIN, MAX)

# Not PAC-compatible: GROUP BY on non-PU column in multi-table join
statement error
SELECT t2.x, SUM(t3.n) FROM t1 INNER JOIN t2 ON t1.a = t2.x INNER JOIN t3 ON t2.x = t3.m GROUP BY t2.x ORDER BY t2.x;
----
PAC rewrite: columns from privacy unit tables can only be accessed inside aggregate functions (e.g., SUM, COUNT, AVG, MIN, MAX)

# Not PAC-compatible: projecting join key from non-PU table (exposes PU column value)
statement error
SELECT t2.x, SUM(t1.b) FROM t1 INNER JOIN t2 ON t1.a = t2.x GROUP BY t2.x ORDER BY t2.x;
----
PAC rewrite: columns from privacy unit tables can only be accessed inside aggregate functions (e.g., SUM, COUNT, AVG, MIN, MAX)

# PAC-compatible: projecting non-join key from non-PU table is OK
query II
SELECT t2.y, SUM(t1.b) FROM t1 INNER JOIN t2 ON t1.a = t2.x GROUP BY t2.y ORDER BY t2.y;
----
100	10
200	20

# Not PAC-compatible: projecting join key in LEFT JOIN (still exposes PU value)
statement error
SELECT t2.x, SUM(t1.b) FROM t1 LEFT JOIN t2 ON t1.a = t2.x GROUP BY t2.x ORDER BY t2.x;
----
PAC rewrite: columns from privacy unit tables can only be accessed inside aggregate functions (e.g., SUM, COUNT, AVG, MIN, MAX)

# PAC-compatible: LEFT JOIN with non-join key projection
# Not PAC-compatible: window function
statement error
SELECT a, SUM(b) OVER (PARTITION BY a) FROM t1;
----
PAC rewrite: window functions are not supported for PAC compilation

# Not PAC-compatible: direct column projection from PU table (no aggregate)
statement error
SELECT a FROM t1;
----
Query does not contain any allowed aggregation (sum, count, avg, min, max)!

# Not PAC-compatible: selecting PU column directly even with aggregate on another column
statement error
SELECT a, SUM(b) FROM t1 GROUP BY a;
----
PAC rewrite: columns from privacy unit tables can only be accessed inside aggregate functions (e.g., SUM, COUNT, AVG, MIN, MAX)

# PAC-compatible: PU column in WHERE clause (this IS allowed)
query I
SELECT SUM(b) FROM t1 WHERE a > 1;
----
90

# Test with joins: PU column cannot be projected directly
statement error
SELECT t1.a FROM t1 INNER JOIN t2 ON t1.a = t2.x;
----
Query does not contain any allowed aggregation (sum, count, avg, min, max)!

# Test with joins: PU column cannot be in GROUP BY
statement error
SELECT t1.a, SUM(t2.y) FROM t1 INNER JOIN t2 ON t1.a = t2.x GROUP BY t1.a;
----
Invalid Input Error: PAC rewrite: columns from privacy unit tables can only be accessed inside aggregate functions (e.g., SUM, COUNT, AVG, MIN, MAX)

# Test with joins: PU column cannot be projected even with non-PU group by
statement error
SELECT t1.a, t2.x, SUM(t1.b) FROM t1 INNER JOIN t2 ON t1.a = t2.x GROUP BY t1.a, t2.x;
----
PAC rewrite: columns from privacy unit tables can only be accessed inside aggregate functions (e.g., SUM, COUNT, AVG, MIN, MAX)

# Test expressions: PU column in arithmetic expression outside aggregate not allowed
statement error
SELECT a * 2 FROM t1;
----
Query does not contain any allowed aggregation (sum, count, avg, min, max)!

# Test expressions: PU column in arithmetic expression INSIDE aggregate is allowed
query I
SELECT SUM(a * 2) FROM t1;
----
18

# Test CASE expression: PU column in CASE outside aggregate not allowed
statement error
SELECT CASE WHEN a > 1 THEN 1 ELSE 0 END FROM t1;
----
Query does not contain any allowed aggregation (sum, count, avg, min, max)!

# Test CASE expression: PU column in CASE inside aggregate is allowed
query I
SELECT SUM(CASE WHEN a > 1 THEN b ELSE 0 END) FROM t1;
----
90

# TODO: Self-join tests below currently succeed but should be rejected once
# stricter join checking between sensitive tables is implemented.
# The self-join detection was disabled/broken - these tests document current behavior.

# Test self-join: currently succeeds (should be rejected in future)
query I
SELECT SUM(t1a.b + t1b.b) FROM t1 t1a JOIN t1 t1b ON t1a.a = t1b.a;
----
340

# Test self-join with different join type: currently succeeds (should be rejected in future)
query I
SELECT COUNT(*) FROM t1 t1a LEFT JOIN t1 t1b ON t1a.a = t1b.a;
----
6

# Test self-join with WHERE clause: currently succeeds (should be rejected in future)
query I
SELECT SUM(t1a.b) FROM t1 t1a, t1 t1b WHERE t1a.a = t1b.a;
----
170

# Test self-join inside subquery: currently crashes due to categorical rewriter issue
# TODO: Fix crash and either reject self-joins or handle them correctly
# Disabled for now:
# statement error
# SELECT SUM(b) FROM t1 WHERE a > (SELECT SUM(t1a.b) FROM t1 t1a JOIN t1 t1b ON t1a.a = t1b.a);
# ----
# PAC rewrite: self-joins are not supported for PAC compilation

# Test same table in main query and subquery (different scopes): should PASS
query I
SELECT SUM(b) FROM t1 WHERE a > (SELECT AVG(b) FROM t1);
----
NULL

# Test conservative mode OFF: subquery should execute normally (no error)
statement ok
SET pac_conservative_mode = false;

# This should succeed when conservative mode is off (query executes without PAC compilation)
query I
SELECT SUM(b) FROM t1 WHERE a IN (SELECT x FROM t2);
----
30

# EXISTS should also succeed when conservative mode is off
query I
SELECT SUM(b) FROM t1 WHERE EXISTS (SELECT 1 FROM t2 WHERE t2.x = t1.a);
----
30

# Window function should succeed when conservative mode is off
query I
SELECT SUM(window_sum) FROM (SELECT a, SUM(b) OVER (PARTITION BY a) as window_sum FROM t1);
----
170

# Self-join should succeed when conservative mode is off
query I
SELECT SUM(t1a.b) FROM t1 t1a JOIN t1 t1b ON t1a.a = t1b.a;
----
170

# Remove table from privacy file via PRAGMA
statement ok
PRAGMA remove_pac_privacy_unit('t1');

# Clean up
statement ok
DROP TABLE t1;

statement ok
DROP TABLE t2;

statement ok
DROP TABLE t3;

# Reset privacy file
statement ok
SET pac_privacy_file = '';

# ============================================================================
# PROTECTED columns tests (PAC metadata PROTECTED attribute)
# ============================================================================

statement ok
SET pac_conservative_mode = true;

# Create a table with columns that will be marked as PROTECTED using CREATE PAC TABLE
statement ok
CREATE PAC TABLE sales(customer_id INTEGER, product_id INTEGER, amount DECIMAL(10,2), quantity INTEGER, PROTECTED (amount, quantity));

statement ok
INSERT INTO sales VALUES (1, 100, 50.00, 2), (1, 101, 30.00, 1), (2, 100, 75.00, 3), (2, 102, 25.00, 1);

# PAC-compatible: protected column inside SUM aggregate
query I
SELECT SUM(amount) FROM sales;
----
180.00

# Not PAC-compatible: protected column in GROUP BY
statement error
SELECT amount, COUNT(*) FROM sales GROUP BY amount;
----
PAC rewrite: protected column 'sales.amount' can only be accessed inside aggregate functions (e.g., SUM, COUNT, AVG, MIN, MAX)

# Not PAC-compatible: protected column in SELECT without aggregate
statement error
SELECT amount FROM sales;
----
PAC rewrite: protected column 'sales.amount' can only be accessed inside aggregate functions (e.g., SUM, COUNT, AVG, MIN, MAX)

# PAC-compatible: non-protected column in GROUP BY with protected column in aggregate
query II
SELECT product_id, SUM(amount) FROM sales GROUP BY product_id ORDER BY product_id;
----
100	125.00
101	30.00
102	25.00

# Not PAC-compatible: protected column projected directly (even with other aggregates)
statement error
SELECT amount, SUM(quantity) FROM sales GROUP BY amount;
----
PAC rewrite: protected column 'sales.amount' can only be accessed inside aggregate functions (e.g., SUM, COUNT, AVG, MIN, MAX)

# PAC-compatible: protected column in WHERE clause with aggregate in SELECT
query I
SELECT SUM(quantity) FROM sales WHERE amount > 30;
----
5

# Create another table for join tests
statement ok
CREATE TABLE products(product_id INTEGER PRIMARY KEY, name VARCHAR, category VARCHAR);

statement ok
INSERT INTO products VALUES (100, 'Widget', 'Hardware'), (101, 'Gadget', 'Electronics'), (102, 'Gizmo', 'Hardware');

# PAC-compatible: join with protected column only in aggregate
query II
SELECT products.category, SUM(sales.amount) FROM sales JOIN products ON sales.product_id = products.product_id GROUP BY products.category ORDER BY products.category;
----
Electronics	30.00
Hardware	150.00

# Not PAC-compatible: protected column in GROUP BY after join
statement error
SELECT sales.amount, COUNT(*) FROM sales JOIN products ON sales.product_id = products.product_id GROUP BY sales.amount;
----
PAC rewrite: protected column 'sales.amount' can only be accessed inside aggregate functions (e.g., SUM, COUNT, AVG, MIN, MAX)

# Clean up protected columns test
statement ok
DROP TABLE sales;

statement ok
DROP TABLE products;

# Test ALTER PAC TABLE to add PROTECTED columns
statement ok
CREATE TABLE employees(id INTEGER, name VARCHAR, salary DECIMAL(10,2), bonus DECIMAL(10,2));

statement ok
INSERT INTO employees VALUES (1, 'Alice', 50000.00, 5000.00), (2, 'Bob', 60000.00, 6000.00), (3, 'Charlie', 55000.00, 5500.00);

# Add PROTECTED columns via ALTER PAC TABLE
statement ok
ALTER PAC TABLE employees ADD PROTECTED (salary);

# PAC-compatible: protected column inside aggregate
query I
SELECT SUM(salary) FROM employees;
----
165000.00

# Not PAC-compatible: protected column in GROUP BY
statement error
SELECT salary, COUNT(*) FROM employees GROUP BY salary;
----
PAC rewrite: protected column 'employees.salary' can only be accessed inside aggregate functions (e.g., SUM, COUNT, AVG, MIN, MAX)

# Non-protected column 'bonus' can still be used freely in GROUP BY
query II
SELECT bonus, COUNT(*) FROM employees GROUP BY bonus ORDER BY bonus;
----
5000.00	1
5500.00	1
6000.00	1

# Clean up
statement ok
DROP TABLE employees;

# ============================================================================
# Test cycle detection in foreign key relationships
# ============================================================================

# Create tables with circular foreign key dependencies
# Tables need PROTECTED columns to be treated as implicit privacy units
statement ok
CREATE PAC TABLE cycle_a (id INTEGER PRIMARY KEY, b_id INTEGER, value_a INTEGER, PROTECTED (value_a));

statement ok
CREATE PAC TABLE cycle_b (id INTEGER PRIMARY KEY, c_id INTEGER, value_b INTEGER, PROTECTED (value_b));

statement ok
CREATE PAC TABLE cycle_c (id INTEGER PRIMARY KEY, a_id INTEGER, value_c INTEGER, PROTECTED (value_c));

# Define PAC LINKs that form a cycle: cycle_a -> cycle_b -> cycle_c -> cycle_a
statement ok
ALTER PAC TABLE cycle_a ADD PAC LINK (b_id) REFERENCES cycle_b(id);

statement ok
ALTER PAC TABLE cycle_b ADD PAC LINK (c_id) REFERENCES cycle_c(id);

statement ok
ALTER PAC TABLE cycle_c ADD PAC LINK (a_id) REFERENCES cycle_a(id);

# Insert some test data
statement ok
INSERT INTO cycle_a VALUES (1, 1, 100), (2, 2, 200);

statement ok
INSERT INTO cycle_b VALUES (1, 1, 300), (2, 2, 400);

statement ok
INSERT INTO cycle_c VALUES (1, 1, 500), (2, 2, 600);

# Test 1: Query on cycle_b should detect FK link cycle
statement error
SELECT SUM(value_b) FROM cycle_b;
----
PAC rewrite: circular foreign key dependencies detected. PAC compilation requires acyclic foreign key relationships.

# Test 2: Query on cycle_c should also detect FK link cycle
statement error
SELECT SUM(value_c) FROM cycle_c;
----
PAC rewrite: circular foreign key dependencies detected. PAC compilation requires acyclic foreign key relationships.

# Test 3: Circular join query (A JOIN B JOIN C JOIN A)
# This forms a query-level cycle independent of FK links
statement error
SELECT SUM(cycle_a.value_a) FROM cycle_a
JOIN cycle_b ON cycle_a.b_id = cycle_b.id
JOIN cycle_c ON cycle_b.c_id = cycle_c.id
JOIN cycle_a AS cycle_a2 ON cycle_c.a_id = cycle_a2.id;
----
PAC rewrite: circular foreign key dependencies detected. PAC compilation requires acyclic foreign key relationships.

# Test 4: With conservative mode off - should not throw error, just skip PAC compilation
statement ok
SET pac_conservative_mode = false;

# FK link cycle - should succeed without PAC compilation
query I
SELECT SUM(value_b) FROM cycle_b;
----
700

# Query-level cycle - should succeed without PAC compilation
query I
SELECT SUM(cycle_a.value_a) FROM cycle_a
JOIN cycle_b ON cycle_a.b_id = cycle_b.id
JOIN cycle_c ON cycle_b.c_id = cycle_c.id
JOIN cycle_a AS cycle_a2 ON cycle_c.a_id = cycle_a2.id;
----
300

# Reset conservative mode
statement ok
SET pac_conservative_mode = true;

# Clean up cycle tables
statement ok
DROP TABLE cycle_a;

statement ok
DROP TABLE cycle_b;

statement ok
DROP TABLE cycle_c;
