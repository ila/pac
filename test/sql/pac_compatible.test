# name: test/sql/pac_compatible.test
# description: test pac extension
# group: [sql]

# --- PAC privacy unit management and compatibility tests ---

require pac

statement ok
SET pac_seed = 42

statement ok
SET pac_deterministic_noise = true

statement ok
SET pac_noise = false;

statement ok
SET pac_privacy_file = 'test/sql/test_pac_tables.csv';

# Ensure test file is clean
query I
PRAGMA remove_pac_privacy_unit('t1');
----

# Create a test table
statement ok
CREATE TABLE t1(a INTEGER, b INTEGER);

statement ok
INSERT INTO t1 VALUES (1, 10), (2, 20), (3, 30), (3 , 40);

# Try PAC-compatible query before adding to privacy file (should not be PAC compatible)
# (Assume your optimizer or extension exposes a function or error for non-PAC queries; adjust as needed)
# Here we just check add/remove and query logic

# Add table to privacy file (pass filename as second argument) via PRAGMA
query I
PRAGMA add_pac_privacy_unit('t1');
----

# Add again using PRAGMA (should be idempotent)
query I
PRAGMA add_pac_privacy_unit('t1');
----

# PAC-compatible query: SUM
query I
SELECT SUM(b) FROM t1;
----
100

# PAC-compatible query: COUNT
query I
SELECT COUNT(*) FROM t1;
----
4

# PAC-compatible query: AVG
query I
SELECT AVG(b) FROM t1;
----
25

# Not PAC-compatible: GROUP BY on PU column (even with aggregate, the GROUP BY itself is not allowed)
statement error
SELECT a, SUM(b) FROM t1 GROUP BY a ORDER BY a;
----
PAC rewrite: columns from privacy unit tables cannot be used in GROUP BY clauses

# PAC-compatible query: INNER JOIN
statement ok
CREATE TABLE t2(x INTEGER, y INTEGER);

statement ok
INSERT INTO t2 VALUES (1, 100), (2, 200);

# Not PAC-compatible: GROUP BY on PU column in join
statement error
SELECT t1.a, SUM(t2.y) FROM t1 INNER JOIN t2 ON t1.a = t2.x GROUP BY t1.a ORDER BY t1.a;
----
PAC rewrite: columns from privacy unit tables cannot be used in GROUP BY clauses

# PAC-compatible: not a PAC query (table not in privacy file)
query II
SELECT * FROM t2;
----
1	100
2	200

# Not PAC-compatible: no aggregate
statement error
SELECT a FROM t1;
----
Query does not contain any allowed aggregation (sum, count, avg, min, max)!

# PAC-compatible: MIN
query I
SELECT MIN(a) FROM t1;
----
1

# PAC-compatible: multiple joins with non-PU GROUP BY
statement ok
CREATE TABLE t3(m INTEGER, n INTEGER);

statement ok
INSERT INTO t3 VALUES (1, 1000), (2, 2000);

# Not PAC-compatible: GROUP BY on PU column even in multi-table join
statement error
SELECT t1.a, SUM(t3.n) FROM t1 INNER JOIN t2 ON t1.a = t2.x INNER JOIN t3 ON t2.x = t3.m GROUP BY t1.a ORDER BY t1.a;
----
PAC rewrite: columns from privacy unit tables cannot be used in GROUP BY clauses

# PAC-compatible: GROUP BY on non-PU column in multi-table join
query II
SELECT t2.x, SUM(t3.n) FROM t1 INNER JOIN t2 ON t1.a = t2.x INNER JOIN t3 ON t2.x = t3.m GROUP BY t2.x ORDER BY t2.x;
----
1	1000
2	2000

# Not PAC-compatible: window function
statement error
SELECT a, SUM(b) OVER (PARTITION BY a) FROM t1;
----
PAC rewrite: window functions are not supported for PAC compilation

# Not PAC-compatible: direct column projection from PU table (no aggregate)
statement error
SELECT a FROM t1;
----
Query does not contain any allowed aggregation (sum, count, avg, min, max)!

# Not PAC-compatible: selecting PU column directly even with aggregate on another column
statement error
SELECT a, SUM(b) FROM t1 GROUP BY a;
----
PAC rewrite: columns from privacy unit tables cannot be used in GROUP BY clauses

# PAC-compatible: PU column in WHERE clause (this IS allowed)
query I
SELECT SUM(b) FROM t1 WHERE a > 1;
----
90

# Test with joins: PU column cannot be projected directly
statement error
SELECT t1.a FROM t1 INNER JOIN t2 ON t1.a = t2.x;
----
Query does not contain any allowed aggregation (sum, count, avg, min, max)!

# Test with joins: PU column cannot be in GROUP BY
statement error
SELECT t1.a, SUM(t2.y) FROM t1 INNER JOIN t2 ON t1.a = t2.x GROUP BY t1.a;
----
PAC rewrite: columns from privacy unit tables cannot be used in GROUP BY clauses

# Test with joins: PU column cannot be projected even with non-PU group by
statement error
SELECT t1.a, t2.x, SUM(t1.b) FROM t1 INNER JOIN t2 ON t1.a = t2.x GROUP BY t2.x;
----
PAC rewrite: columns from privacy unit tables can only be accessed inside aggregate functions (e.g., SUM, COUNT, AVG, MIN, MAX)

# Test expressions: PU column in arithmetic expression outside aggregate not allowed
statement error
SELECT a * 2 FROM t1;
----
Query does not contain any allowed aggregation (sum, count, avg, min, max)!

# Test expressions: PU column in arithmetic expression INSIDE aggregate is allowed
query I
SELECT SUM(a * 2) FROM t1;
----
18

# Test CASE expression: PU column in CASE outside aggregate not allowed
statement error
SELECT CASE WHEN a > 1 THEN 1 ELSE 0 END FROM t1;
----
Query does not contain any allowed aggregation (sum, count, avg, min, max)!

# Test CASE expression: PU column in CASE inside aggregate is allowed
query I
SELECT SUM(CASE WHEN a > 1 THEN b ELSE 0 END) FROM t1;
----
90

# Remove table from privacy file via PRAGMA
statement ok
PRAGMA remove_pac_privacy_unit('t1');

# Clean up
statement ok
DROP TABLE t1;

statement ok
DROP TABLE t2;

statement ok
DROP TABLE t3;

statement ok
SET pac_noise = true;

# Test: queries that already reference the internal PAC sample table should skip PAC compilation
statement ok
DROP TABLE IF EXISTS t_single;

statement ok
CREATE TABLE t_single(rowid BIGINT, group_key VARCHAR, val DOUBLE);

statement ok
INSERT INTO t_single VALUES (1,'A',10.0),(2,'A',11.0),(3,'B',20.0);

statement ok
CREATE TABLE _pac_internal_sample_t_single(rowid BIGINT, sample_id BIGINT);

statement ok
INSERT INTO _pac_internal_sample_t_single VALUES (1,1),(2,1),(3,1);

statement ok
PRAGMA add_pac_privacy_unit('t_single');

# The query references both the privacy unit table and the internal sample table. The optimizer
# should detect the internal sample and skip PAC compilation, so the real aggregation result
# should be produced (not the DUMMY output from the PAC compiler).

query II
SELECT t.group_key, SUM(t.val) FROM t_single t JOIN _pac_internal_sample_t_single s USING(rowid) GROUP BY t.group_key ORDER BY t.group_key;
----
A	21
B	20

statement ok
PRAGMA remove_pac_privacy_unit('t_single');

statement ok
DROP TABLE IF EXISTS t_single;

# Reset privacy file
statement ok
SET pac_privacy_file = '';
