# name: test/sql/pac_avg.test
# description: Test pac_avg aggregate function
# group: [sql]

require pac

statement ok
PRAGMA enable_verification

# Create test data with 4000 rows
statement ok
CREATE TABLE test_data AS
SELECT i AS rowid, i % 3 AS grp, (i % 100) AS value
FROM range(4000) t(i)

# Ungrouped pac_avg with INTEGER
query I
SELECT pac_avg(hash(rowid)::UBIGINT, value::INTEGER) IS NOT NULL FROM test_data
----
true

# Verify returns DOUBLE for integers
query I
SELECT typeof(pac_avg(hash(rowid)::UBIGINT, value::INTEGER)) FROM test_data
----
DOUBLE

# Test with explicit mi parameter (128.0)
query I
SELECT pac_avg(hash(rowid)::UBIGINT, value::INTEGER, 128.0) IS NOT NULL FROM test_data
----
true

# Grouped pac_avg
query II
SELECT grp, pac_avg(hash(rowid)::UBIGINT, value::INTEGER) IS NOT NULL AS has_result
FROM test_data
GROUP BY grp
ORDER BY grp
----
0	true
1	true
2	true

# Test with different numeric types
query I
SELECT pac_avg(hash(rowid)::UBIGINT, value::BIGINT) IS NOT NULL FROM test_data
----
true

query I
SELECT pac_avg(hash(rowid)::UBIGINT, value::DOUBLE) IS NOT NULL FROM test_data
----
true

query I
SELECT pac_avg(hash(rowid)::UBIGINT, value::FLOAT) IS NOT NULL FROM test_data
----
true

query I
SELECT pac_avg(hash(rowid)::UBIGINT, value::SMALLINT) IS NOT NULL FROM test_data
----
true

query I
SELECT pac_avg(hash(rowid)::UBIGINT, (value % 127)::TINYINT) IS NOT NULL FROM test_data
----
true

# Verify return type is always DOUBLE
query I
SELECT typeof(pac_avg(hash(rowid)::UBIGINT, value::BIGINT)) FROM test_data
----
DOUBLE

query I
SELECT typeof(pac_avg(hash(rowid)::UBIGINT, value::DOUBLE)) FROM test_data
----
DOUBLE

query I
SELECT typeof(pac_avg(hash(rowid)::UBIGINT, value::TINYINT)) FROM test_data
----
DOUBLE

# ===========================================================
# NULL propagation tests - pac_avg returns NULL when any input is NULL
# ===========================================================

# Test ungrouped: NULL in value causes NULL result
query I
SELECT pac_avg(hash(rowid)::UBIGINT, CASE WHEN rowid = 100 THEN NULL ELSE value END::INTEGER) FROM test_data
----
NULL

# Test ungrouped: NULL in key_hash causes NULL result
query I
SELECT pac_avg(CASE WHEN rowid = 50 THEN NULL ELSE hash(rowid)::UBIGINT END, value::INTEGER) FROM test_data
----
NULL

# Test grouped: NULL only affects the group that has it
statement ok
CREATE TABLE test_null_groups AS
SELECT i AS rowid, i % 3 AS grp,
       CASE WHEN i = 0 THEN NULL ELSE (i % 100)::INTEGER END AS value
FROM range(30) t(i)

# Group 0 has rowid=0 which has NULL value, so group 0 result is NULL
# Groups 1 and 2 have no NULLs, so they should have non-NULL results
query II
SELECT grp, pac_avg(hash(rowid)::UBIGINT, value) IS NULL AS is_null
FROM test_null_groups
GROUP BY grp
ORDER BY grp
----
0	true
1	false
2	false

statement ok
DROP TABLE test_null_groups

# ===========================================================
# Accuracy tests - pac_avg should be close to actual AVG
# ===========================================================

# With large enough data, pac_avg should be reasonably close to AVG
# Using a tolerance of 10% of the actual average
query I
SELECT abs(pac_avg(hash(rowid)::UBIGINT, value::INTEGER) - AVG(value)) < (AVG(value) * 0.1) FROM test_data
----
true

# Test grouped accuracy
query I
SELECT COUNT(*) = 3 FROM (
    SELECT grp, pac_avg(hash(rowid)::UBIGINT, value::INTEGER) AS pa, AVG(value) AS a
    FROM test_data
    GROUP BY grp
    HAVING abs(pa - a) < (a * 0.2)
)
----
true

# ===========================================================
# Edge cases
# ===========================================================

# Single row - pac_avg should return value itself (with noise)
statement ok
CREATE TABLE test_single AS
SELECT 1 AS rowid, 42.0 AS value

query I
SELECT pac_avg(hash(rowid)::UBIGINT, value) IS NOT NULL FROM test_single
----
true

statement ok
DROP TABLE test_single

# All same values - average should be close to that value
statement ok
CREATE TABLE test_constant AS
SELECT i AS rowid, 50.0 AS value FROM range(1000) t(i)

query I
SELECT abs(pac_avg(hash(rowid)::UBIGINT, value) - 50.0) < 10 FROM test_constant
----
true

statement ok
DROP TABLE test_constant

# Cleanup
statement ok
DROP TABLE test_data
