# name: test/sql/pac_avg.test
# description: Test pac_avg aggregate function
# group: [sql]

require pac

statement ok
PRAGMA clear_pac_metadata;

statement ok
PRAGMA enable_verification

# Set deterministic seed for cross-CPU reproducibility
statement ok
SET pac_seed = 42

statement ok
SET pac_deterministic_noise = true

statement ok
SET threads = 1

statement ok
SET pac_mi = 0

# Create test data with 4000 rows
statement ok
CREATE TABLE test_data AS
SELECT i AS rowid, i % 3 AS grp, (i % 100) AS value
FROM range(4000) t(i)

# Ungrouped pac_avg with INTEGER
query I
SELECT pac_avg(hash(rowid)::UBIGINT, value::INTEGER) IS NOT NULL FROM test_data
----
true

# Verify returns DOUBLE for integers
query I
SELECT typeof(pac_avg(hash(rowid)::UBIGINT, value::INTEGER)) FROM test_data
----
DOUBLE

# Test with non-zero mi parameter (deterministic results due to pac_seed)
statement ok
SET pac_mi = 128

query I
SELECT pac_avg(hash(rowid)::UBIGINT, value::INTEGER) IS NOT NULL FROM test_data
----
true

statement ok
SET pac_mi = 0

# Test with explicit mi parameter (0.0 for no noise)
query I
SELECT pac_avg(hash(rowid)::UBIGINT, value::INTEGER) IS NOT NULL FROM test_data
----
true

# Grouped pac_avg
query II
SELECT grp, pac_avg(hash(rowid)::UBIGINT, value::INTEGER) IS NOT NULL AS has_result
FROM test_data
GROUP BY grp
ORDER BY grp
----
0	true
1	true
2	true

# Test with different numeric types
query I
SELECT pac_avg(hash(rowid)::UBIGINT, value::BIGINT) IS NOT NULL FROM test_data
----
true

query I
SELECT pac_avg(hash(rowid)::UBIGINT, value::DOUBLE) IS NOT NULL FROM test_data
----
true

query I
SELECT pac_avg(hash(rowid)::UBIGINT, value::FLOAT) IS NOT NULL FROM test_data
----
true

query I
SELECT pac_avg(hash(rowid)::UBIGINT, value::SMALLINT) IS NOT NULL FROM test_data
----
true

query I
SELECT pac_avg(hash(rowid)::UBIGINT, (value % 127)::TINYINT) IS NOT NULL FROM test_data
----
true

# Verify return type is always DOUBLE
query I
SELECT typeof(pac_avg(hash(rowid)::UBIGINT, value::BIGINT)) FROM test_data
----
DOUBLE

query I
SELECT typeof(pac_avg(hash(rowid)::UBIGINT, value::DOUBLE)) FROM test_data
----
DOUBLE

query I
SELECT typeof(pac_avg(hash(rowid)::UBIGINT, value::TINYINT)) FROM test_data
----
DOUBLE

# ===========================================================
# NULL handling tests - pac_avg ignores NULLs (safe behavior, like DuckDB's AVG)
# ===========================================================

# Test ungrouped: NULL in value is ignored, result is NOT NULL
query I
SELECT pac_avg(hash(rowid)::UBIGINT, CASE WHEN rowid = 100 THEN NULL ELSE value END::INTEGER) IS NOT NULL FROM test_data
----
true

# Test ungrouped: NULL in key_hash is ignored, result is NOT NULL
query I
SELECT pac_avg(CASE WHEN rowid = 50 THEN NULL ELSE hash(rowid)::UBIGINT END, value::INTEGER) IS NOT NULL FROM test_data
----
true

# Test grouped: NULLs are ignored, all groups have non-NULL results
statement ok
CREATE TABLE test_null_groups AS
SELECT i AS rowid, i % 3 AS grp,
       CASE WHEN i = 0 THEN NULL ELSE (i % 100)::INTEGER END AS value
FROM range(30) t(i)

# All groups should have non-NULL results (NULLs are just ignored)
query II
SELECT grp, pac_avg(hash(rowid)::UBIGINT, value) IS NULL AS is_null
FROM test_null_groups
GROUP BY grp
ORDER BY grp
----
0	false
1	false
2	false

statement ok
DROP TABLE test_null_groups

# ===========================================================
# Accuracy tests - pac_avg should be close to actual AVG
# ===========================================================

# With large enough data, pac_avg should be reasonably close to AVG
# Using a tolerance of 10% of the actual average
query I
SELECT abs(pac_avg(hash(rowid)::UBIGINT, value::INTEGER) - AVG(value)) < (AVG(value) * 0.1) FROM test_data
----
true

# Test grouped accuracy
query I
SELECT COUNT(*) = 3 FROM (
    SELECT grp, pac_avg(hash(rowid)::UBIGINT, value::INTEGER) AS pa, AVG(value) AS a
    FROM test_data
    GROUP BY grp
    HAVING abs(pa - a) < (a * 0.2)
)
----
true

# ===========================================================
# Edge cases
# ===========================================================

# Single row - pac_avg may return NULL based on key_hash bit pattern
statement ok
CREATE TABLE test_single AS
SELECT 1 AS rowid, 42.0 AS value

query I
SELECT pac_avg(hash(rowid)::UBIGINT, value) IS NOT NULL FROM test_single
----
1

statement ok
DROP TABLE test_single

# All same values - average should be close to that value
statement ok
CREATE TABLE test_constant AS
SELECT i AS rowid, 50.0 AS value FROM range(1000) t(i)

query I
SELECT abs(pac_avg(hash(rowid)::UBIGINT, value) - 50.0) < 10 FROM test_constant
----
true

statement ok
DROP TABLE test_constant

# Cleanup
statement ok
DROP TABLE test_data

# Cleanup PAC metadata at end of test
statement ok
PRAGMA clear_pac_metadata;
