# name: test/sql/pac_min_max.test
# description: Test pac_min and pac_max aggregate functions
# group: [sql]

require pac

statement ok
PRAGMA clear_pac_metadata;

# Set deterministic seed for cross-CPU reproducibility
statement ok
SET pac_seed = 42

statement ok
SET pac_deterministic_noise = true

statement ok
SET threads = 1

statement ok
SET pac_mi = 0

# =============================================================================
# pac_max tests
# =============================================================================

# Test pac_max with TINYINT (INT8)
query I
SELECT pac_max(hash('key' || i::varchar), i::tinyint) FROM range(1, 50) t(i);
----
48

# Test pac_max with SMALLINT (INT16)
query I
SELECT pac_max(hash('key' || i::varchar), i::smallint) FROM range(1, 100) t(i);
----
99

# Test pac_max with INTEGER (INT32)
query I
SELECT pac_max(hash('key' || i::varchar), i::integer) FROM range(1, 100) t(i);
----
99

# Test pac_max with BIGINT (INT64)
query I
SELECT pac_max(hash('key' || i::varchar), i::bigint) FROM range(1, 100) t(i);
----
99

# Test pac_max with UTINYINT (UINT8)
query I
SELECT pac_max(hash('key' || i::varchar), i::utinyint) FROM range(1, 50) t(i);
----
48

# Test pac_max with USMALLINT (UINT16)
query I
SELECT pac_max(hash('key' || i::varchar), i::usmallint) FROM range(1, 100) t(i);
----
99

# Test pac_max with UINTEGER (UINT32)
query I
SELECT pac_max(hash('key' || i::varchar), i::uinteger) FROM range(1, 100) t(i);
----
99

# Test pac_max with UBIGINT (UINT64)
query I
SELECT pac_max(hash('key' || i::varchar), i::ubigint) FROM range(1, 100) t(i);
----
99

# Test pac_max with FLOAT
query R
SELECT round(pac_max(hash('key' || i::varchar), i::float), 1) FROM range(1, 100) t(i);
----
99.0

# Test pac_max with DOUBLE
query R
SELECT round(pac_max(hash('key' || i::varchar), i::double), 1) FROM range(1, 100) t(i);
----
99.0

# Test pac_max with negative values (signed types)
query I
SELECT pac_max(hash('key' || i::varchar), i::integer) FROM range(-50, 50) t(i);
----
48

# Test pac_max with non-zero mi parameter (deterministic results due to pac_seed)
statement ok
SET pac_mi = 128

query I
SELECT pac_max(hash('key' || i::varchar), i::integer) IS NOT NULL FROM range(1, 100) t(i);
----
true

statement ok
SET pac_mi = 0

# Test pac_max with mi parameter (0.0 for no noise)
query I
SELECT pac_max(hash('key' || i::varchar), i::integer) FROM range(1, 100) t(i);
----
99

# =============================================================================
# pac_min tests
# =============================================================================

# Test pac_min with TINYINT (INT8)
query I
SELECT pac_min(hash('key' || i::varchar), i::tinyint) FROM range(1, 50) t(i);
----
2

# Test pac_min with SMALLINT (INT16)
query I
SELECT pac_min(hash('key' || i::varchar), i::smallint) FROM range(1, 100) t(i);
----
2

# Test pac_min with INTEGER (INT32)
query I
SELECT pac_min(hash('key' || i::varchar), i::integer) FROM range(1, 100) t(i);
----
2

# Test pac_min with BIGINT (INT64)
query I
SELECT pac_min(hash('key' || i::varchar), i::bigint) FROM range(1, 100) t(i);
----
2

# Test pac_min with UTINYINT (UINT8)
query I
SELECT pac_min(hash('key' || i::varchar), i::utinyint) FROM range(1, 50) t(i);
----
2

# Test pac_min with USMALLINT (UINT16)
query I
SELECT pac_min(hash('key' || i::varchar), i::usmallint) FROM range(1, 100) t(i);
----
2

# Test pac_min with UINTEGER (UINT32)
query I
SELECT pac_min(hash('key' || i::varchar), i::uinteger) FROM range(1, 100) t(i);
----
2

# Test pac_min with UBIGINT (UINT64)
query I
SELECT pac_min(hash('key' || i::varchar), i::ubigint) FROM range(1, 100) t(i);
----
2

# Test pac_min with FLOAT
query R
SELECT round(pac_min(hash('key' || i::varchar), i::float), 1) FROM range(1, 100) t(i);
----
2.0

# Test pac_min with DOUBLE
query R
SELECT round(pac_min(hash('key' || i::varchar), i::double), 1) FROM range(1, 100) t(i);
----
2.0

# Test pac_min with negative values (signed types)
query I
SELECT pac_min(hash('key' || i::varchar), i::integer) FROM range(-50, 50) t(i);
----
-50

# Test pac_min with mi parameter (0.0 for deterministic results)
query I
SELECT pac_min(hash('key' || i::varchar), i::integer) FROM range(1, 100) t(i);
----
2

# =============================================================================
# GROUP BY tests
# =============================================================================

# Test pac_max with GROUP BY (mi=0 returns actual values, not NULL)
query II rowsort
SELECT i % 3 as grp, pac_max(hash('key' || i::varchar), i::integer)
FROM range(1, 100) t(i)
GROUP BY grp;
----
0	99
1	94
2	95

# Test pac_min with GROUP BY (mi=0 returns actual values, not NULL)
query II rowsort
SELECT i % 3 as grp, pac_min(hash('key' || i::varchar), i::integer)
FROM range(1, 100) t(i)
GROUP BY grp;
----
0	6
1	7
2	2

# =============================================================================
# Edge cases
# =============================================================================

# Test with single value (mi=0 returns actual value)
query I
SELECT pac_max(1::UBIGINT, 42::integer);
----
42

query I
SELECT pac_min(1::UBIGINT, 42::integer);
----
42

# Test with large values (BIGINT)
query I
SELECT pac_max(hash('key' || i::varchar), (i * 1000000000)::bigint) FROM range(1, 100) t(i);
----
99000000000

query I
SELECT pac_min(hash('key' || i::varchar), (i * 1000000000)::bigint) FROM range(1, 100) t(i);
----
2000000000

# Test with small range
query I
SELECT pac_max(hash('key' || i::varchar), i::integer) FROM range(1, 10) t(i);
----
7

# Test with scaled values
query I
SELECT pac_max(hash('key' || i::varchar), (i * 100)::integer) FROM range(1, 10) t(i);
----
700

# Test with larger scaled values
query I
SELECT pac_max(hash('key' || i::varchar), (i * 100000)::integer) FROM range(1, 10) t(i);
----
700000

# Test float with scaling
query R
SELECT round(pac_max(hash('key' || i::varchar), (i * 100.0)::double), 1) FROM range(1, 100) t(i);
----
9900.0

query R
SELECT round(pac_min(hash('key' || i::varchar), (i * 100.0)::double), 1) FROM range(1, 100) t(i);
----
200.0

# Test double with large values
query R
SELECT round(pac_max(hash('key' || i::varchar), (i * 2000000.0)::double), 0) FROM range(1, 100) t(i);
----
198000000.0

query R
SELECT round(pac_min(hash('key' || i::varchar), (i * 2000000.0)::double), 0) FROM range(1, 100) t(i);
----
4000000.0

# =============================================================================
# HUGEINT tests
# =============================================================================

# Test pac_max with HUGEINT
query I
SELECT pac_max(hash('key' || i::varchar), i::hugeint) FROM range(1, 100) t(i);
----
99

# Test pac_min with HUGEINT
query I
SELECT pac_min(hash('key' || i::varchar), i::hugeint) FROM range(1, 100) t(i);
----
2

# Test pac_max with large HUGEINT values (multiplied by large factor)
query I
SELECT pac_max(hash('key' || i::varchar), (i::hugeint * 10000000000000::hugeint)) FROM range(1, 100) t(i);
----
990000000000000

# Test pac_min with large HUGEINT values
query I
SELECT pac_min(hash('key' || i::varchar), (i::hugeint * 10000000000000::hugeint)) FROM range(1, 100) t(i);
----
20000000000000

# Test pac_max with negative HUGEINT values
query I
SELECT pac_max(hash('key' || i::varchar), i::hugeint) FROM range(-50, 50) t(i);
----
48

# Test pac_min with negative HUGEINT values
query I
SELECT pac_min(hash('key' || i::varchar), i::hugeint) FROM range(-50, 50) t(i);
----
-50

# =============================================================================
# UHUGEINT tests
# =============================================================================

# Test pac_max with UHUGEINT
query I
SELECT pac_max(hash('key' || i::varchar), i::uhugeint) FROM range(1, 100) t(i);
----
99

# Test pac_min with UHUGEINT
query I
SELECT pac_min(hash('key' || i::varchar), i::uhugeint) FROM range(1, 100) t(i);
----
2

# Test pac_max with large UHUGEINT values
query I
SELECT pac_max(hash('key' || i::varchar), (i::uhugeint * 10000000000000::uhugeint)) FROM range(1, 100) t(i);
----
990000000000000

# Test pac_min with large UHUGEINT values
query I
SELECT pac_min(hash('key' || i::varchar), (i::uhugeint * 10000000000000::uhugeint)) FROM range(1, 100) t(i);
----
20000000000000

# =============================================================================
# DATE tests
# =============================================================================

# Test pac_max with DATE
query I
SELECT pac_max(hash('key' || i::varchar), ('2020-01-01'::date + i::integer)::date) FROM range(1, 100) t(i);
----
2020-04-09

# Test pac_min with DATE
query I
SELECT pac_min(hash('key' || i::varchar), ('2020-01-01'::date + i::integer)::date) FROM range(1, 100) t(i);
----
2020-01-03

# =============================================================================
# TIME tests
# =============================================================================

# Test pac_max with TIME
query I
SELECT pac_max(hash('key' || i::varchar), ('00:00:00'::time + (i * interval '1 minute'))::time) FROM range(1, 100) t(i);
----
01:39:00

# Test pac_min with TIME
query I
SELECT pac_min(hash('key' || i::varchar), ('00:00:00'::time + (i * interval '1 minute'))::time) FROM range(1, 100) t(i);
----
00:02:00

# =============================================================================
# TIMESTAMP tests
# =============================================================================

# Test pac_max with TIMESTAMP
query I
SELECT pac_max(hash('key' || i::varchar), ('2020-01-01 00:00:00'::timestamp + (i * interval '1 day'))::timestamp) FROM range(1, 100) t(i);
----
2020-04-09 00:00:00

# Test pac_min with TIMESTAMP
query I
SELECT pac_min(hash('key' || i::varchar), ('2020-01-01 00:00:00'::timestamp + (i * interval '1 day'))::timestamp) FROM range(1, 100) t(i);
----
2020-01-03 00:00:00

# =============================================================================
# TIMESTAMP WITH TIME ZONE tests
# =============================================================================

# Test pac_max with TIMESTAMPTZ
query I
SELECT pac_max(hash('key' || i::varchar), (('2020-01-01 00:00:00'::timestamp + (i * interval '1 day'))::timestamptz)) FROM range(1, 100) t(i);
----
2020-04-09 00:00:00+00

# Test pac_min with TIMESTAMPTZ
query I
SELECT pac_min(hash('key' || i::varchar), (('2020-01-01 00:00:00'::timestamp + (i * interval '1 day'))::timestamptz)) FROM range(1, 100) t(i);
----
2020-01-03 00:00:00+00

# =============================================================================
# DECIMAL tests
# =============================================================================

# Test pac_max with DECIMAL(4,2) - maps to INT16
query I
SELECT pac_max(hash('key' || i::varchar), (i * 0.5)::decimal(4,2)) FROM range(1, 100) t(i);
----
49.50

# Test pac_min with DECIMAL(4,2)
query I
SELECT pac_min(hash('key' || i::varchar), (i * 0.5)::decimal(4,2)) FROM range(1, 100) t(i);
----
1.00

# Test pac_max with DECIMAL(9,2) - maps to INT32
query I
SELECT pac_max(hash('key' || i::varchar), (i * 1.5)::decimal(9,2)) FROM range(1, 100) t(i);
----
148.50

# Test pac_min with DECIMAL(9,2)
query I
SELECT pac_min(hash('key' || i::varchar), (i * 1.5)::decimal(9,2)) FROM range(1, 100) t(i);
----
3.00

# Test pac_max with DECIMAL(18,2) - maps to INT64
query I
SELECT pac_max(hash('key' || i::varchar), (i * 1.5)::decimal(18,2)) FROM range(1, 100) t(i);
----
148.50

# Test pac_min with DECIMAL(18,2)
query I
SELECT pac_min(hash('key' || i::varchar), (i * 1.5)::decimal(18,2)) FROM range(1, 100) t(i);
----
3.00

# Test pac_max with DECIMAL(38,2) - maps to HUGEINT
query I
SELECT pac_max(hash('key' || i::varchar), (i * 1.5)::decimal(38,2)) FROM range(1, 100) t(i);
----
148.50

# Test pac_min with DECIMAL(38,2)
query I
SELECT pac_min(hash('key' || i::varchar), (i * 1.5)::decimal(38,2)) FROM range(1, 100) t(i);
----
3.00
